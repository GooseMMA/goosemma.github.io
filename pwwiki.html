<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OGPS Wiki — Pixel Worlds</title>
  <style>
    :root {
      --bg: #070c15;
      --panel: #0c1524;
      --accent: #28d1ff;
      --accent2: #9b5cff;
      --text: #e8f2ff;
      --muted: #9aaac5;
      --common: #c0c0c0;
      --uncommon: #5cff73;
      --rare: #5ca8ff;
      --epic: #d25cff;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg) url('bg.gif') center/cover fixed;
      color: var(--text);
      overflow: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(7, 12, 21, 0.88);
      pointer-events: none;
      z-index: -1;
    }

    header {
      display: flex;
      align-items: center;
      background: var(--panel);
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      gap: 12px;
    }

    #search {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: none;
      border-radius: 8px;
      color: var(--text);
      padding: 10px 14px;
      font-size: 16px;
      outline: none;
      transition: background 0.3s;
    }
    #search:focus {
      background: rgba(255,255,255,0.1);
    }

    #showTreeBtn {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #showTreeBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 12px rgba(40, 209, 255, 0.4);
    }

    main {
      display: grid;
      grid-template-columns: 260px 1fr 320px;
      height: calc(100vh - 64px);
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
      #itemList { order: 1; max-height: 180px; overflow-y: auto; }
      #details { order: 2; }
      #treePanel { order: 3; height: auto; }
    }

    #itemList {
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,0.1);
      overflow-y: auto;
      padding: 12px;
    }

    #itemList div {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.25s, transform 0.2s;
    }
    #itemList div:hover {
      background: rgba(255,255,255,0.07);
      transform: translateX(4px);
    }

    #itemList img {
      width: 36px;
      height: 36px;
      image-rendering: pixelated;
      border-radius: 4px;
    }

    #details {
      padding: 24px;
      overflow-y: auto;
    }

    #details img {
      width: 72px;
      height: 72px;
      image-rendering: pixelated;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }

    #details h2 {
      margin: 0 0 16px 0;
      font-size: 26px;
      color: var(--accent);
    }

    .field {
      margin: 8px 0;
      color: var(--muted);
    }
    .field strong { color: var(--text); }

    .craft-ingredients {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .craft-ingredients button {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .craft-ingredients button:hover {
      background: rgba(255,255,255,0.12);
    }

    #treePanel {
      position: relative;
      background: radial-gradient(circle at center, rgba(255,255,255,0.02), transparent 70%);
      border-left: 1px solid rgba(255,255,255,0.1);
      overflow: auto;
      display: none;
    }
    #treePanel.active {
      display: block;
    }

    .tree-node {
      position: absolute;
      text-align: center;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.3s cubic-bezier(0.17, 0.67, 0.38, 0.96), background 0.3s;
      cursor: pointer;
    }
    .tree-node:hover {
      background: rgba(255,255,255,0.1);
      transform: scale(1.08);
      z-index: 10;
    }

    .tree-node img {
      width: 52px;
      height: 52px;
      image-rendering: pixelated;
      display: block;
      margin: 0 auto 6px;
    }

    .rarity-common { color: var(--common); }
    .rarity-uncommon { color: var(--uncommon); }
    .rarity-rare { color: var(--rare); }
    .rarity-epic { color: var(--epic); }
  </style>
</head>
<body>
  <header>
    <input type="text" id="search" placeholder="Search items (e.g. gry blok)" autocomplete="off">
    <button id="showTreeBtn">Show Global Craft Tree</button>
  </header>

  <main>
    <aside id="itemList"></aside>
    <section id="details">
      <h2>Welcome to OGPS Wiki</h2>
      <p>Select an item from the list to view its details and craft tree.</p>
    </section>
    <section id="treePanel">
      <svg id="treeLines" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></svg>
    </section>
  </main>

  <script>
    let ITEMS = [];
    let ITEM_MAP = {};

    const searchInput = document.getElementById('search');
    const itemList = document.getElementById('itemList');
    const details = document.getElementById('details');
    const treePanel = document.getElementById('treePanel');
    const treeLines = document.getElementById('treeLines');
    const showTreeBtn = document.getElementById('showTreeBtn');

    // === LOAD DATA ===
    async function loadData() {
      try {
        const res = await fetch('items.json?_=' + Date.now());
        ITEMS = await res.json();
        ITEM_MAP = {};
        ITEMS.forEach(item => ITEM_MAP[item.name] = item);
        renderList();
      } catch (e) {
        details.innerHTML = `<h2>❌ Error</h2><p>Failed to load items.json. Make sure it's in the same folder.</p>`;
      }
    }

    // === FUZZY SEARCH ===
    function fuzzyMatch(query, text) {
      query = query.toLowerCase();
      text = text.toLowerCase();
      let j = 0;
      for (let i = 0; i < query.length; i++) {
        const idx = text.indexOf(query[i], j);
        if (idx === -1) return false;
        j = idx + 1;
      }
      return true;
    }

    // === RENDER LIST ===
    function renderList(filter = '') {
      itemList.innerHTML = '';
      const itemsToShow = filter
        ? ITEMS.filter(i => fuzzyMatch(filter, i.name))
        : ITEMS;
      itemsToShow.forEach(item => {
        const div = document.createElement('div');
        div.innerHTML = `<img src="${item.image || 'images/missing.png'}" alt="${item.name}"><span>${item.name}</span>`;
        div.onclick = () => showItem(item.name);
        itemList.appendChild(div);
      });
    }

    // === SHOW ITEM ===
    function showItem(name) {
      const item = ITEM_MAP[name];
      if (!item) return;

      let html = `
        <img src="${item.image || 'images/missing.png'}" alt="${item.name}">
        <h2>${item.name}</h2>
        <p>${item.description || 'No description.'}</p>
        <div class="field"><strong>Complexity:</strong> ${item.complexity !== undefined ? item.complexity : 'N/A'}</div>
        <div class="field"><strong>Tier:</strong> ${item.tier !== undefined ? item.tier : 'N/A'}</div>
        <div class="field"><strong>Rarity:</strong> <span class="rarity-${(item.rarity || 'common').toLowerCase()}">${item.rarity || 'Common'}</span></div>
        <div class="field"><strong>Item Type:</strong> ${item.itemType || 'N/A'}</div>
        <div class="field"><strong>Farmability:</strong> ${item.farmability || 'N/A'}</div>
        <div class="field"><strong>Growth Time:</strong> ${item.growthTime || 'N/A'}</div>
      `;

      if (item.craftable && item.craft && item.craft.length > 0) {
        html += `<div class="field"><strong>Craft:</strong></div><div class="craft-ingredients">`;
        item.craft.forEach(ing => {
          html += `<button onclick="showItem('${ing.replace(/'/g, "\\'")}')">${ing}</button>`;
        });
        html += `</div>`;
      }

      if (item.trivia && item.trivia.length > 0) {
        html += `<div class="field"><strong>Trivia:</strong></div><ul>`;
        item.trivia.forEach(t => html += `<li>${t}</li>`);
        html += `</ul>`;
      }

      details.innerHTML = html;
    }

    // === TREE LOGIC ===
    function buildTreeLevels(target) {
      let levels = [[target]];
      let visited = new Set([target]);
      for (let depth = 0; depth < 5; depth++) {
        let current = levels[depth];
        let next = [];
        ITEMS.forEach(item => {
          if (item.craft && item.craft.includes(target)) {
            if (!visited.has(item.name)) {
              next.push(item.name);
              visited.add(item.name);
            }
          }
        });
        if (next.length === 0) break;
        levels.push(next);
        target = next[0]; // simplistic — for full tree, use BFS from root
      }
      return levels.reverse();
    }

    function drawTree(rootName) {
      treePanel.querySelectorAll('.tree-node').forEach(e => e.remove());
      treeLines.innerHTML = '';

      const levels = buildTreeLevels(rootName);
      const nodeWidth = 130;
      const nodeHeight = 100;
      const hSpacing = 160;
      const vSpacing = 140;
      const startX = 100;
      const startY = 80;

      const nodePositions = {};

      levels.forEach((level, i) => {
        const y = startY + i * vSpacing;
        const totalWidth = level.length * hSpacing;
        const levelStartX = startX + (treePanel.clientWidth - totalWidth) / 2;
        level.forEach((name, j) => {
          const x = levelStartX + j * hSpacing;
          const item = ITEM_MAP[name];
          if (!item) return;

          const node = document.createElement('div');
          node.className = 'tree-node';
          node.style.left = x + 'px';
          node.style.top = y + 'px';
          node.innerHTML = `<img src="${item.image || 'images/missing.png'}"><div>${item.name}</div>`;
          node.onclick = () => showItem(name);
          treePanel.appendChild(node);
          nodePositions[name] = { x: x + nodeWidth / 2, y: y + 60 };
        });
      });

      // Draw lines (simple: from ingredient to result)
      ITEMS.forEach(item => {
        if (!item.craft || !nodePositions[item.name]) return;
        item.craft.forEach(ing => {
          if (nodePositions[ing]) {
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', nodePositions[ing].x);
            line.setAttribute('y1', nodePositions[ing].y);
            line.setAttribute('x2', nodePositions[item.name].x);
            line.setAttribute('y2', nodePositions[item.name].y);
            line.setAttribute('stroke', 'rgba(255,255,255,0.35)');
            line.setAttribute('stroke-width', '2');
            treeLines.appendChild(line);
          }
        });
      });
    }

    // === EVENTS ===
    searchInput.addEventListener('input', (e) => {
      renderList(e.target.value.trim());
    });

    showTreeBtn.addEventListener('click', () => {
      treePanel.classList.toggle('active');
      if (treePanel.classList.contains('active')) {
        // Draw full craft tree (all craftable items)
        treePanel.querySelectorAll('.tree-node').forEach(e => e.remove());
        treeLines.innerHTML = '';

        const craftable = ITEMS.filter(i => i.craftable);
        const nodeWidth = 120;
        const spacing = 140;
        const startX = 100;
        const startY = 100;

        craftable.forEach((item, i) => {
          const x = startX + (i % 6) * spacing;
          const y = startY + Math.floor(i / 6) * spacing;
          const node = document.createElement('div');
          node.className = 'tree-node';
          node.style.left = x + 'px';
          node.style.top = y + 'px';
          node.innerHTML = `<img src="${item.image || 'images/missing.png'}"><div>${item.name}</div>`;
          node.onclick = () => {
            showItem(item.name);
            treePanel.classList.remove('active');
          };
          treePanel.appendChild(node);
        });
      }
    });

    loadData();
  </script>
</body>
</html>
