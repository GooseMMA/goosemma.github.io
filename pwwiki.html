<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OGPS Wiki — Pixel Worlds Crafts</title>

<style>
:root {
  --bg: #070c15;
  --panel: #0c1524;
  --accent: #28d1ff;
  --accent2: #9b5cff;
  --text: #e8f2ff;
  --muted: #9aaac5;
  --common: #c0c0c0;
  --uncommon: #5cff73;
  --rare: #5ca8ff;
  --epic: #d25cff;
}

body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
}

/* === HEADER === */
header {
  display: flex;
  align-items: center;
  background: var(--panel);
  padding: 8px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

#siteIcon {
  height: 40px;
  width: 40px;
  margin-right: 12px;
}

#search {
  flex: 1;
  background: rgba(255,255,255,0.05);
  border: none;
  border-radius: 8px;
  color: var(--text);
  padding: 8px 12px;
  font-size: 16px;
  outline: none;
}

/* === LAYOUT === */
main {
  display: grid;
  grid-template-columns: 250px 1fr 300px;
  height: calc(100vh - 60px);
}

aside {
  background: var(--panel);
  border-right: 1px solid rgba(255,255,255,0.1);
  overflow-y: auto;
  padding: 10px;
}

#itemsList div {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}
#itemsList div:hover { background: rgba(255,255,255,0.05); }

#itemsList img {
  width: 32px;
  height: 32px;
  border-radius: 4px;
}

/* === ITEM DETAILS === */
#details {
  padding: 20px;
  overflow-y: auto;
}

#details img {
  width: 64px;
  height: 64px;
}

#details h2 {
  margin: 0;
  font-size: 24px;
}

/* === TREE VIEW === */
#tree {
  position: relative;
  overflow: auto;
  background: radial-gradient(circle at center, rgba(255,255,255,0.03), transparent 70%);
  border-left: 1px solid rgba(255,255,255,0.1);
}

.tree-node {
  position: absolute;
  text-align: center;
  padding: 8px;
  border-radius: 8px;
  background: rgba(255,255,255,0.05);
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  transition: transform 0.2s, background 0.2s;
}

.tree-node:hover {
  background: rgba(255,255,255,0.1);
  transform: scale(1.05);
}

.tree-node img {
  width: 48px;
  height: 48px;
  display: block;
  margin: auto;
}

/* === TRENDING === */
#trending {
  padding: 10px;
  border-top: 1px solid rgba(255,255,255,0.1);
}
#trending h3 { margin-top: 10px; }

.trend-item {
  font-size: 14px;
  color: var(--muted);
}

</style>
</head>
<body>

<header>
  <!-- Иконка сайта -->
  <img id="siteIcon" src="assets/icon.png" alt="Site icon">
  <input type="text" id="search" placeholder="Search items...">
</header>

<main>
  <!-- Список предметов -->
  <aside>
    <div id="itemsList"></div>
    <div id="trending">
      <h3>🔥 Trending</h3>
      <div id="trendList"></div>
    </div>
  </aside>

  <!-- Информация о предмете -->
  <section id="details">
    <h2>Select an item</h2>
    <p>Click an item to view its recipe tree.</p>
  </section>

  <!-- Дерево крафта -->
  <section id="tree">
    <svg id="treeLines" width="100%" height="100%" style="position:absolute;top:0;left:0;"></svg>
  </section>
</main>

<script>
let items = {};
let recipes = [];
let trending = JSON.parse(localStorage.getItem("trending") || "{}");
const listDiv = document.getElementById("itemsList");
const details = document.getElementById("details");
const trendDiv = document.getElementById("trendList");
const treeDiv = document.getElementById("tree");
const treeLines = document.getElementById("treeLines");

/* ====== Load crafts.json ====== */
async function loadData() {
  try {
    const res = await fetch("crafts.json");
    const data = await res.json();
    items = data.items;
    recipes = data.recipes;
  } catch {
    console.warn("crafts.json not found, using demo data");
    items = {
      "lava": {name:"Lava",desc:"Burning molten fluid",image:"images/lava.png",rarity:"common"},
      "marble": {name:"Marble",desc:"Smooth decorative block",image:"images/marble.png",rarity:"uncommon"},
      "obsidian": {name:"Obsidian",desc:"Hardened volcanic glass",image:"images/obsidian.png",rarity:"rare"}
    };
    recipes = [{inputs:["lava","marble"],output:"obsidian"}];
  }
  renderList();
  renderTrending();
}

/* ====== Render item list ====== */
function renderList(filter="") {
  listDiv.innerHTML = "";
  const normalized = filter.toLowerCase();
  for (let id in items) {
    const item = items[id];
    if (fuzzyMatch(item.name.toLowerCase(), normalized)) {
      const div = document.createElement("div");
      div.innerHTML = `<img src="${item.image}"><span>${item.name}</span>`;
      div.onclick = () => showItem(id);
      listDiv.appendChild(div);
    }
  }
}

/* ====== Simple fuzzy match ====== */
function fuzzyMatch(str, pattern) {
  let i=0,j=0;
  while (i<str.length && j<pattern.length) {
    if (str[i]===pattern[j]) j++;
    i++;
  }
  return j===pattern.length;
}

/* ====== Show item details ====== */
function showItem(id) {
  const item = items[id];
  trending[id] = (trending[id]||0)+1;
  localStorage.setItem("trending", JSON.stringify(trending));
  renderTrending();

  details.innerHTML = `
    <img src="${item.image}">
    <h2>${item.name}</h2>
    <p>${item.desc}</p>
    <p><b>Rarity:</b> <span style="color:var(--${item.rarity||'common'})">${item.rarity||'common'}</span></p>
  `;
  drawTree(id);
}

/* ====== Render Trending ====== */
function renderTrending() {
  const sorted = Object.entries(trending).sort((a,b)=>b[1]-a[1]).slice(0,5);
  trendDiv.innerHTML = sorted.map(([id,v])=>`<div class="trend-item">${items[id]?.name || id} (${v})</div>`).join("");
}

/* ====== Draw Craft Tree ====== */
function drawTree(id) {
  treeDiv.querySelectorAll(".tree-node").forEach(e=>e.remove());
  treeLines.innerHTML="";
  const levels = buildTreeLevels(id);
  const nodePositions = {};
  const levelHeight = 150;
  const nodeWidth = 120;
  const startY = 50;
  levels.forEach((level,i)=>{
    const y = startY + i*levelHeight;
    const totalWidth = level.length * (nodeWidth + 60);
    const startX = (treeDiv.clientWidth - totalWidth)/2;
    level.forEach((node,j)=>{
      const x = startX + j*(nodeWidth+60);
      const div = document.createElement("div");
      div.className="tree-node";
      div.style.left=x+"px";
      div.style.top=y+"px";
      div.innerHTML=`<img src="${items[node]?.image||''}"><div>${items[node]?.name||node}</div>`;
      div.onclick=()=>showItem(node);
      treeDiv.appendChild(div);
      nodePositions[node]={x:x+nodeWidth/2, y:y+40};
    });
  });
  // Draw lines
  recipes.forEach(r=>{
    if (r.output===id || levels.flat().includes(r.output)) {
      r.inputs.forEach(inp=>{
        if (nodePositions[inp] && nodePositions[r.output]) {
          const line = document.createElementNS("http://www.w3.org/2000/svg","line");
          line.setAttribute("x1", nodePositions[inp].x);
          line.setAttribute("y1", nodePositions[inp].y);
          line.setAttribute("x2", nodePositions[r.output].x);
          line.setAttribute("y2", nodePositions[r.output].y);
          line.setAttribute("stroke", "rgba(255,255,255,0.3)");
          line.setAttribute("stroke-width", "2");
          treeLines.appendChild(line);
        }
      });
    }
  });
}

/* ====== Build tree levels ====== */
function buildTreeLevels(target) {
  let levels = [[target]];
  let visited = new Set([target]);
  for (let i=0; i<5; i++) {
    let prev = levels[i];
    let next = [];
    recipes.forEach(r=>{
      if (prev.includes(r.output)) {
        r.inputs.forEach(inp=>{
          if (!visited.has(inp)) {
            next.push(inp);
            visited.add(inp);
          }
        });
      }
    });
    if (next.length===0) break;
    levels.push(next);
  }
  return levels.reverse();
}

/* ====== SEARCH ====== */
document.getElementById("search").addEventListener("input", e=>{
  renderList(e.target.value);
});

loadData();
</script>
</body>
</html>
