<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор анимации шариков</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        #controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        #canvas {
            border: 1px solid #ccc;
            max-width: 100%;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label>Цвет шарика: <input type="color" id="ballColor" value="#ff0000"></label>
        <label>Действие: 
            <select id="ballAction">
                <option value="bounce">Отскакивать</option>
                <option value="break">Разрушаться</option>
            </select>
        </label>
        <label>Объект столкновения: 
            <select id="collisionObject">
                <option value="wall">Стена</option>
                <option value="cube">Куб</option>
            </select>
        </label>
        <button onclick="startAnimation()">Запустить</button>
        <button onclick="downloadVideo()" id="downloadBtn" disabled>Скачать видео</button>
    </div>
    <canvas id="canvas"></canvas>

    <!-- Подключение библиотек -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ccapture.js/1.1.0/CCapture.all.min.js"></script>
    <script>
        // Настройка Matter.js
        const Engine = Matter.Engine;
        const World = Matter.World;
        const Bodies = Matter.Bodies;
        const engine = Engine.create();
        const world = engine.world;

        // Настройка Canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800;
        canvas.height = 600;

        // Переменные для анимации
        let ball, collisionObj;
        let particles = [];
        let capturer = new CCapture({ format: 'webm', framerate: 30 });
        let recording = false;
        let frameCount = 0;
        const maxFrames = 180; // 6 секунд при 30 fps

        // Функция запуска анимации
        function startAnimation() {
            // Очистка мира
            World.clear(world);
            particles = [];
            frameCount = 0;

            // Параметры пользователя
            const color = document.getElementById('ballColor').value;
            const action = document.getElementById('ballAction').value;
            const collision = document.getElementById('collisionObject').value;

            // Создание шарика
            ball = Bodies.circle(400, 50, 20, { 
                restitution: action === 'bounce' ? 0.8 : 0, 
                render: { fillStyle: color }
            });
            World.add(world, ball);

            // Создание объекта столкновения
            if (collision === 'wall') {
                collisionObj = Bodies.rectangle(400, 600, 810, 60, { isStatic: true });
            } else if (collision === 'cube') {
                collisionObj = Bodies.rectangle(400, 500, 100, 100, { isStatic: true });
            }
            World.add(world, collisionObj);

            // Старт записи
            capturer = new CCapture({ format: 'webm', framerate: 30 });
            capturer.start();
            recording = true;
            document.getElementById('downloadBtn').disabled = true;

            animate();
        }

        // Создание частиц при разрушении
        function createParticles(x, y, color) {
            for (let i = 0; i < 10; i++) {
                const particle = Bodies.circle(x, y, 5, {
                    restitution: 0.5,
                    friction: 0.1,
                    render: { fillStyle: color },
                    timeScale: 0.5
                });
                Matter.Body.setVelocity(particle, {
                    x: (Math.random() - 0.5) * 10,
                    y: (Math.random() - 0.5) * 10
                });
                particles.push(particle);
                World.add(world, particle);
            }
        }

        // Основной цикл анимации
        function animate() {
            Engine.update(engine);

            // Очистка canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Отрисовка шарика
            ctx.beginPath();
            ctx.arc(ball.position.x, ball.position.y, 20, 0, Math.PI * 2);
            ctx.fillStyle = ball.render.fillStyle;
            ctx.fill();

            // Отрисовка объекта столкновения
            ctx.fillStyle = '#666';
            ctx.fillRect(
                collisionObj.position.x - collisionObj.bounds.max.x + collisionObj.position.x,
                collisionObj.position.y - collisionObj.bounds.max.y + collisionObj.position.y,
                collisionObj.bounds.max.x - collisionObj.bounds.min.x,
                collisionObj.bounds.max.y - collisionObj.bounds.min.y
            );

            // Обработка столкновения
            if (Matter.Bounds.overlaps(ball.bounds, collisionObj.bounds)) {
                if (document.getElementById('ballAction').value === 'break' && particles.length === 0) {
                    createParticles(ball.position.x, ball.position.y, ball.render.fillStyle);
                    World.remove(world, ball);
                }
            }

            // Отрисовка частиц
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.position.x, p.position.y, 5, 0, Math.PI * 2);
                ctx.fillStyle = p.render.fillStyle;
                ctx.fill();
            });

            // Запись кадров
            if (recording) {
                capturer.capture(canvas);
                frameCount++;
                if (frameCount >= maxFrames) {
                    stopRecording();
                    return;
                }
            }

            requestAnimationFrame(animate);
        }

        // Остановка записи и активация скачивания
        function stopRecording() {
            recording = false;
            capturer.stop();
            capturer.save(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ball_animation.webm';
                a.click();
                URL.revokeObjectURL(url);
            });
            document.getElementById('downloadBtn').disabled = false;
        }

        // Функция скачивания видео
        function downloadVideo() {
            if (!recording) {
                startAnimation(); // Перезапуск для скачивания
            }
        }

        // Адаптивность canvas
        function resizeCanvas() {
            const maxWidth = window.innerWidth - 40;
            const maxHeight = window.innerHeight - 200;
            canvas.width = Math.min(800, maxWidth);
            canvas.height = Math.min(600, maxHeight);
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>
</body>
</html>